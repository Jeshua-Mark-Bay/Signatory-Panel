<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Digital Signature with Bootstrap 4</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

    <style>
        /* Base styling for the canvas container */
        #signatureCanvasContainer {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            /* Important for fixing the cursor movement issue in some browsers/devices */
            touch-action: none; 
            cursor: none;
            position: relative;
            width: 100%;
            /* Maintain 16:9 aspect ratio or similar, adjusting for visual size */
            padding-bottom: 50%; 
            height: 0;
            overflow: hidden;
            background-color: #fff;
        }
        
        #signatureCanvasContainer canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Overlay Canvas for the visual cursor indicator */
        #cursorOverlay {
            pointer-events: none; 
        }

        .hidden {
            display: none !important; /* The !important rule is added here */
        }

        /* Utility for the Export dropdown */
        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 0.25rem 1rem !important;
        }

        .dropdown-item span{
            margin-right: 0.5rem;
        }

        /* Custom style for highlighting the active mode button */
        .mode-active {
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5); /* Bootstrap primary color glow */
            border-color: #007bff !important;
        }
        
        /* Fix for range input thumb size in Bootstrap 4 */
        #penThickness::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 1rem;
            width: 1rem;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }
        #penThickness::-moz-range-thumb {
            height: 1rem;
            width: 1rem;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Style for the preview image container */
        .img-preview-container {
            border: 1px solid #ccc;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }
        #imgPreview {
            max-width: 100%;
            height: auto;
        }
        
        /* Utility Group Styling for Layout */
        .utility-group {
            display: flex;
            flex-wrap: nowrap; /* Prevent wrapping on small screens for this row */
            align-items: center;
        }
        
        /* Ensure buttons within the utility group have minimal margin for tight grouping */
        .utility-group .btn {
            margin-left: 0.25rem;
            margin-right: 0.25rem;
        }
        .utility-group .btn:first-child {
             margin-left: 0;
        }
        .utility-group .btn:last-child {
             margin-right: 0;
        }
        
        /* Small screen adjustments for controls */
        @media (max-width: 991.98px) {
            .full-control-row {
                flex-direction: column;
                align-items: stretch !important;
            }
            #penControls {
                width: 100%;
                margin-right: 0 !important;
                margin-bottom: 1rem !important;
            }
            .mode-toggle-group {
                justify-content: center;
                margin-bottom: 1rem;
            }
            .utility-group {
                justify-content: space-between;
                width: 100%;
            }
            .utility-group .btn, .utility-group .dropdown {
                flex-grow: 1;
                margin: 0 0.25rem;
            }
        }
    </style>
</head>
<body class="bg-light">

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card shadow">
                    <div class="card-body">
                        <h2 class="card-title text-center mb-4">Document Signer</h2>
                        
                        <div class="mb-4">
                            <button type="button" class="btn btn-primary btn-lg btn-block" data-toggle="modal" data-target="#signatureModal">
                                <i class="fas fa-signature mr-2"></i> Sign Document
                            </button>
                        </div>
                        
                        <h5>Signature Preview:</h5>
                        <div class="img-preview-container mb-3">
                            <img id="imgPreview" src="" alt="Your Digital Signature Preview" class="img-fluid" style="display:none;"/>
                            <p id="noSignatureMessage" class="text-muted">Click "Sign Document" to create your signature.</p>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="signatureModal" tabindex="-1" aria-labelledby="signatureModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                
                <div class="modal-header">
                    <h5 class="modal-title" id="signatureModalLabel">Digital Signature Editor</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                
                <div class="modal-body">

                    <div id="signatureCanvasContainer" class="mb-3">
                        <canvas id="signatureCanvas"></canvas>
                        <canvas id="cursorOverlay"></canvas>
                    </div>

                    <div class="full-control-row d-flex flex-column flex-lg-row align-items-lg-center justify-content-between p-3 bg-light rounded mx-0">
                        
                        <div id="penControls" class="d-flex align-items-center p-0 flex-grow-1 mr-lg-3">
                            <div class="d-flex align-items-center pr-1 mr-3">
                                <label for="penColor" class="text-sm font-weight-bold mr-1 text-nowrap">Color:</label>
                                <input type="color" id="penColor" value="#000000" class="border-0 rounded-circle p-1" style="width: 2.2rem; height: 2.2rem; cursor: pointer;">
                            </div>
                            <div class="flex-grow-1 pr-1">
                                <label for="penThickness" class="text-sm font-weight-bold w-100 text-nowrap">Thick (<span id="thicknessValue">2.0</span>):</label>
                                <input type="range" id="penThickness" min="0.5" max="10" step="0.5" value="2.0" class="custom-range">
                            </div>
                        </div>

                        <div class="mode-toggle-group d-flex justify-content-center mx-lg-3">
                            <button id="toggleDraw" class="btn btn-primary font-weight-bold text-nowrap mode-active mr-2" title="Activate Drawing Mode">
                                <i class="fas fa-pen"></i> <span class="d-none d-sm-inline">Draw</span>
                            </button>
                            <button id="toggleErase" class="btn btn-secondary font-weight-bold text-nowrap" title="Activate Erasing Mode">
                                <i class="fas fa-eraser"></i> <span class="d-none d-sm-inline">Erase</span>
                            </button>
                        </div>
                        
                        <div class="utility-group d-flex justify-content-lg-end flex-grow-1 ml-lg-3">
                            <button id="undo" class="btn btn-secondary font-weight-bold" disabled title="Undo Last Stroke">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button id="redo" class="btn btn-secondary font-weight-bold" disabled title="Redo Last Undo">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button id="clear" class="btn btn-danger font-weight-bold" disabled title="Clear Canvas">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <div class="ml-2 dropdown">
                                <button id="exportDropdownButton" class="btn btn-info dropdown-toggle font-weight-bold" type="button" aria-expanded="false" disabled title="Export Signature">
                                    <i class="fas fa-download mr-1"></i> Export
                                </button>

                                <div id="exportDropdownMenu" class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item d-flex justify-content-between" href="#" id="exportPngOpaque"><span>PNG</span> <small class="text-muted">(White Background)</small></a>
                                    <a class="dropdown-item d-flex justify-content-between" href="#" id="exportPngTransparent"><span>PNG</span> <small class="text-muted">(Transparent)</small></a> 
                                    <a class="dropdown-item d-flex justify-content-between" href="#" id="exportJpeg"><span>JPEG</span> <small class="text-muted">(Lossy)</small></a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item d-flex justify-content-between" href="#" id="exportSvg"><span>SVG</span> <small class="text-muted">(Vector)</small></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="applySignatureButton" disabled>Apply</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const canvas = document.getElementById('signatureCanvas');
            const overlayCanvas = document.getElementById('cursorOverlay');
            const penColorInput = document.getElementById('penColor');
            const penThicknessInput = document.getElementById('penThickness');
            const thicknessValueSpan = document.getElementById('thicknessValue');
            const toggleDrawButton = document.getElementById('toggleDraw');
            const toggleEraseButton = document.getElementById('toggleErase');
            const clearButton = document.getElementById('clear');
            const undoButton = document.getElementById('undo');
            const redoButton = document.getElementById('redo');
            const applySignatureButton = document.getElementById('applySignatureButton');
            const imgPreview = document.getElementById('imgPreview');
            const noSignatureMessage = document.getElementById('noSignatureMessage');
            
            // Export Dropdown elements
            const exportDropdownButton = document.getElementById('exportDropdownButton');
            const exportDropdownMenu = document.getElementById('exportDropdownMenu');
            const exportPngTransparent = document.getElementById('exportPngTransparent');
            
            // --- State Variables ---
            let signaturePad = null;
            let overlayCtx = null;
            let history = []; 
            let historyPointer = -1;
            let isErasing = false;
            // hasErased tracks if any erase stroke was ever completed on the current signature
            let hasErased = false; 
            let currentPenColor = '#000000';
            let currentPenWidth = parseFloat(penThicknessInput.value); 
            
            // --- CONSTANTS ---
            const BACKGROUND_COLOR = 'rgba(0,0,0,0)'; 
            const DRAWING_BACKGROUND_COLOR = '#ffffff';
            const ERASER_INTERNAL_COLOR = '#FFFFFE'; 
            const RATIO = Math.max(1, window.devicePixelRatio || 1);
            const cursorScaleFactor = 2; 
            
            // --- 1. Initialization and Resizing ---

            function resizeCanvas() {
                const ratio = RATIO; 
                // Only save data if signaturePad is initialized to avoid errors
                const data = signaturePad ? signaturePad.toData() : null; 

                const container = document.getElementById('signatureCanvasContainer');
                const width = container.offsetWidth;
                const height = container.offsetHeight;

                // Set drawing canvas size (scaled)
                canvas.width = width * ratio;
                canvas.height = height * ratio;
                canvas.getContext('2d').scale(ratio, ratio);

                // Set overlay canvas size (scaled)
                overlayCanvas.width = width * ratio;
                overlayCanvas.height = height * ratio; 
                overlayCtx = overlayCanvas.getContext('2d');
                overlayCtx.scale(ratio, ratio);

                // Restore signature after resize
                if (data && signaturePad) {
                    signaturePad.clear(); 
                    signaturePad.fromData(data);
                }
            }

            function initSignaturePad() {
                signaturePad = new SignaturePad(canvas, {
                    backgroundColor: BACKGROUND_COLOR,
                    penColor: currentPenColor,
                    minWidth: currentPenWidth * 1,
                    maxWidth: currentPenWidth * 1.1,
                    throttle: 16
                });
                
                // CRUCIAL: Call resize on load and when the modal is shown to ensure correct dimensions
                resizeCanvas(); 

                // jQuery modal event to ensure resize happens when modal is shown
                $('#signatureModal').on('shown.bs.modal', function () {
                    resizeCanvas();
                    // Reset state on initial load/clear
                    if (historyPointer === -1) {
                        // signaturePad.clear() is implicitly called by resizeCanvas on first run
                        history = [];
                        historyPointer = -1;
                        hasErased = false;
                        setMode('draw'); // Ensure draw mode is active on start
                    }
                });

                window.addEventListener('resize', resizeCanvas);

                signaturePad.addEventListener("endStroke", () => {
                    // CRUCIAL LOGIC: Set the flag if the eraser was active during this stroke
                    if (isErasing) {
                        hasErased = true;
                    }
                    
                    // Simple check if a stroke was actually drawn before saving history
                    if (!signaturePad.isEmpty()) { 
                        saveHistory(); 
                    }
                    updateButtons();
                });
            }

            // --- 2. History Management ---

            function saveHistory() {
                // Discard all redos
                history = history.slice(0, historyPointer + 1);
                // Deep copy data for history state
                const data = signaturePad.toData().map(group => ({ ...group, points: [...group.points] }));
                history.push(data);
                historyPointer = history.length - 1;
            }

            function loadState(index) {
                // Allow index -1 for a completely cleared state
                if (index >= -1 && index < history.length) {
                    historyPointer = index;
                    signaturePad.clear();
                    
                    if (historyPointer >= 0) {
                        signaturePad.fromData(history[historyPointer]);
                    }
                    
                    // Reapply mode settings (mode is not part of history state)
                    signaturePad.globalCompositeOperation = isErasing ? 'destination-out' : 'source-over';
                    signaturePad.penColor = isErasing ? ERASER_INTERNAL_COLOR : currentPenColor;

                    // 'hasErased' state is sticky unless cleared, so no change here.
                    updateButtons();
                }
            }

            function undo() {
                if (historyPointer >= 0) {
                    loadState(historyPointer - 1);
                }
            }

            function redo() {
                if (historyPointer < history.length - 1) {
                    loadState(historyPointer + 1);
                }
            }
            
            // --- 3. Cursor Overlay ---
            
            let isDrawing = false;
            
            // Handle mouse/pen down to track drawing state
            canvas.addEventListener('mousedown', (e) => { 
                console.log(e.button);
                // Prevent mouse down on overlay canvas which is impossible due to pointer-events: none, 
                // but this listener is on the drawing canvas
                if (e.button === 0) { // Only track left click
                     isDrawing = true; 
                     // IMPORTANT: Clear the cursor while drawing, but keep the mousemove listener
                     // active for the eraser fix below.
                     clearCursorOverlay(); 
                }
            });
            // Handle mouse/pen up to track drawing state
            canvas.addEventListener('mouseup', () => { 
                isDrawing = false; 
                // Redraw cursor at the last position after finishing the stroke
            });
            // Handle mouse/pen leaving the canvas
            canvas.addEventListener('mouseout', clearCursorOverlay);
            
            // Fix: Draw the cursor *while* erasing, not just hovering
            canvas.addEventListener('mousemove', (e) => {
                // Draw cursor if: 1. Not drawing (hovering) OR 2. Currently drawing AND in Erasing mode
                if (!isDrawing || (isDrawing && isErasing)) { 
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left; 
                    const y = e.clientY - rect.top;
                    drawCursorOverlay(x, y);
                } else if (isDrawing && !isErasing) {
                    // If drawing a pen stroke, clear the visual cursor
                    clearCursorOverlay();
                }
            });

            function clearCursorOverlay() {
                if (overlayCtx) {
                    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                }
            }

            function drawCursorOverlay(x, y) {
                if (!overlayCtx) return;

                // Clears the previous cursor position
                overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

                const radius = (currentPenWidth * cursorScaleFactor) / 2; 

                overlayCtx.beginPath();
                overlayCtx.arc(x, y, radius, 0, 2 * Math.PI);

                if (isErasing) {
                    // Eraser cursor styling (dashed black circle)
                    overlayCtx.strokeStyle = 'rgba(0, 0, 0, 0.7)'; 
                    overlayCtx.lineWidth = 1;
                    overlayCtx.setLineDash([3, 3]);
                    overlayCtx.fillStyle = 'rgba(255, 255, 255, 0.3)'; 
                    overlayCtx.fill();
                    overlayCtx.stroke();
                } else {
                    // Pen cursor styling (semi-transparent fill of current color)
                    overlayCtx.setLineDash([]); 
                    // Using currentPenColor + 4D for 30% opacity, assuming a hex color
                    overlayCtx.fillStyle = `${currentPenColor}4D`; 
                    overlayCtx.fill();
                    overlayCtx.strokeStyle = `${currentPenColor}`; 
                    overlayCtx.lineWidth = 0.5;
                    overlayCtx.stroke();
                }
                overlayCtx.closePath();
            }


            // --- 4. UI State and Controls ---

            function setMode(mode) {
                if (mode === 'erase') {
                    isErasing = true;
                    signaturePad.globalCompositeOperation = 'destination-out';
                    signaturePad.penColor = ERASER_INTERNAL_COLOR; 
                    penColorInput.disabled = true;
                    
                    // Highlight Erase button
                    toggleDrawButton.classList.remove('mode-active', 'btn-primary');
                    toggleDrawButton.classList.add('btn-secondary');
                    toggleEraseButton.classList.add('mode-active', 'btn-primary');
                    toggleEraseButton.classList.remove('btn-secondary');
                } else { // 'draw'
                    isErasing = false;
                    signaturePad.globalCompositeOperation = 'source-over'; 
                    signaturePad.penColor = currentPenColor; 
                    penColorInput.disabled = false;
                    
                    // Highlight Draw button
                    toggleEraseButton.classList.remove('mode-active', 'btn-primary');
                    toggleEraseButton.classList.add('btn-secondary');
                    toggleDrawButton.classList.add('mode-active', 'btn-primary');
                    toggleDrawButton.classList.remove('btn-secondary');
                }
                // Call clear cursor to make sure the visual state updates instantly
                clearCursorOverlay(); 
                updateButtons();
            }

            function updateButtons() {
                const hasContent = !signaturePad.isEmpty();
                const canUndo = historyPointer > -1;
                const canRedo = historyPointer < history.length - 1;
                // FIX 1: Clear button enabled if there is anything in history to clear (drawn or redrawn)
                const hasHistory = history.length > 0;

                clearButton.disabled = !hasHistory;
                undoButton.disabled = !canUndo;
                redoButton.disabled = !canRedo;
                exportDropdownButton.disabled = !hasContent;
                applySignatureButton.disabled = !hasContent;

                if (!hasContent) {
                    exportDropdownMenu.classList.remove('show');
                }

                // FIX 2: Transparent PNG Logic: Hide if there is content AND the eraser was used.
                // If it is empty, the export button is disabled anyway.
                if (hasContent && hasErased) {
                    exportPngTransparent.classList.add('hidden');
                } else {
                    exportPngTransparent.classList.remove('hidden');
                }
            }
            
            // --- Event Listeners ---
            
            penColorInput.addEventListener('input', (e) => {
                currentPenColor = e.target.value;
                if (!isErasing) {
                    signaturePad.penColor = currentPenColor;
                }
            });

            penThicknessInput.addEventListener('input', (e) => {
                currentPenWidth = parseFloat(e.target.value);
                thicknessValueSpan.textContent = currentPenWidth.toFixed(1); 
                
                signaturePad.minWidth = currentPenWidth * 1;
                signaturePad.maxWidth = currentPenWidth * 1.1;
                
                // Immediately update cursor size on thickness change
                clearCursorOverlay();
                // Simulate a mouse move to update the cursor position/size if the mouse is still over the canvas
                const container = document.getElementById('signatureCanvasContainer');
                const rect = container.getBoundingClientRect();
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: rect.left + container.offsetWidth / 2,
                    clientY: rect.top + container.offsetHeight / 2
                });
                canvas.dispatchEvent(mouseEvent);
            });

            toggleDrawButton.addEventListener('click', () => setMode('draw'));
            toggleEraseButton.addEventListener('click', () => setMode('erase'));
            
            clearButton.addEventListener('click', () => {
                signaturePad.clear();
                history = [];
                historyPointer = -1;
                hasErased = false; // Reset the erase flag, making transparent export available
                updateButtons();
            });

            document.getElementById('undo').addEventListener('click', undo);
            document.getElementById('redo').addEventListener('click', redo);

            // Manual Dropdown Toggle for Export Button
            exportDropdownButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (!exportDropdownButton.disabled) {
                    exportDropdownMenu.classList.toggle('show');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!exportDropdownButton.contains(e.target) && !exportDropdownMenu.contains(e.target)) {
                    exportDropdownMenu.classList.remove('show');
                }
            });

            // --- 5. Apply Signature Functionality ---
            
            applySignatureButton.addEventListener('click', () => {
                if (signaturePad.isEmpty()) return;
                
                // CRITICAL LOGIC: Force OPAQUE preview if the eraser was used.
                if (hasErased) {
                    // exportOpaque handles putting the signature on a white background
                    exportOpaque('image/png', 'preview.png', 1.0, true); 
                } else {
                    // Use transparent PNG data
                    const dataURL = signaturePad.toDataURL('image/png'); 
                    imgPreview.src = dataURL;
                    imgPreview.style.display = 'block';
                    noSignatureMessage.style.display = 'none';
                }

                $('#signatureModal').modal('hide');
            });


            // --- 6. Export Functions ---
            
            function download(dataURL, filename) {
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = filename;
                document.body.appendChild(a);
                a.click(); 
                document.body.removeChild(a);
            }

            // Export to PNG/JPEG with White Background
            function exportOpaque(mimeType, filename, quality, isPreview = false) {
                if (signaturePad.isEmpty()) return;
                
                // Get the current signature data URL (will be transparent)
                const signatureDataURL = signaturePad.toDataURL('image/png'); 
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const img = new Image();
                
                // Match the actual size of the signaturePad's canvas (scaled)
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                // Since dataURL is based on the unscaled view, scale the context before drawing
                tempCtx.scale(RATIO, RATIO);
                
                img.onload = () => {
                    // Draw white background
                    tempCtx.fillStyle = DRAWING_BACKGROUND_COLOR; 
                    // Fill the unscaled area
                    tempCtx.fillRect(0, 0, tempCanvas.width / RATIO, tempCanvas.height / RATIO); 
                    // Draw the signature (it already respects the scaling)
                    tempCtx.drawImage(img, 0, 0, tempCanvas.width / RATIO, tempCanvas.height / RATIO);
                    
                    // Final image dataURL
                    const opaqueDataURL = tempCanvas.toDataURL(mimeType, quality);
                    
                    if (isPreview) {
                        imgPreview.src = opaqueDataURL;
                        imgPreview.style.display = 'block';
                        noSignatureMessage.style.display = 'none';
                    } else {
                        download(opaqueDataURL, filename);
                    }
                };
                img.src = signatureDataURL;
            }

            document.getElementById('exportPngOpaque').addEventListener('click', (e) => {
                e.preventDefault();
                exportDropdownMenu.classList.remove('show');
                exportOpaque('image/png', 'signature_opaque.png', 1.0);
            });

            document.getElementById('exportPngTransparent').addEventListener('click', (e) => {
                e.preventDefault();
                exportDropdownMenu.classList.remove('show');
                // Block download if canvas is empty or eraser was used
                if (signaturePad.isEmpty() || hasErased) return; 

                const dataURL = signaturePad.toDataURL('image/png'); 
                download(dataURL, 'signature_transparent.png');
            });

            document.getElementById('exportJpeg').addEventListener('click', (e) => {
                e.preventDefault();
                exportDropdownMenu.classList.remove('show');
                exportOpaque('image/jpeg', 'signature.jpeg', 0.8);
            });

            document.getElementById('exportSvg').addEventListener('click', (e) => {
                e.preventDefault();
                exportDropdownMenu.classList.remove('show');
                if (signaturePad.isEmpty()) return;
                
                const svg = signaturePad.toSVG();
                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                download(url, 'signature.svg');
            });
            
            // Start everything up
            initSignaturePad();
            setMode('draw');
        });
    </script>
</body>
</html>