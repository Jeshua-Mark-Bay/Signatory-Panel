<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signature Modal Example</title>

  <!-- ✅ Bootstrap 4.6.2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>

  <!-- ✅ Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Segoe UI", sans-serif;
    }

    #signatureCanvas {
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      height: 200px;
      background-color: #fff;
    }

    #signaturePreview {
      border: 1px solid #ccc;
      max-width: 300px;
      display: block;
      margin-top: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<div class="container mt-4">
  <button class="btn btn-primary" onclick="openSignatureModal()">Open Signature Modal</button>
</div>

<!-- Signature Modal -->
<div class="modal fade" id="signatureModal" tabindex="-1" role="dialog" aria-labelledby="signatureModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="signatureModalLabel">Create Signature</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body text-center">
        <canvas id="signatureCanvas"></canvas>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear</button>
        <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="applySignature()">Apply</button>
      </div>
    </div>
  </div>
</div>

<!-- Signature Preview and Save -->
<div class="container mt-4">
  <h5>Signature Preview:</h5>
  <img id="signaturePreview" src="" alt="Your signature will appear here.">

  <button class="btn btn-success mt-3" onclick="saveSignature()">Save Signature</button>
</div>

<script>
  let signaturePad;
  let currentSignature = null;

  // ✅ Initialize SignaturePad only AFTER modal becomes visible
  $('#signatureModal').on('shown.bs.modal', function () {
    const canvas = document.getElementById('signatureCanvas');
    resizeCanvas(canvas);
    signaturePad = new SignaturePad(canvas, {
      backgroundColor: 'rgb(255,255,255)'
    });

    // If editing, redraw previous signature
    if (currentSignature) {
      const img = new Image();
      img.src = currentSignature;
      img.onload = function () {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
    }
  });

  // ✅ Open modal
  function openSignatureModal() {
    $('#signatureModal').modal('show');
  }

  // ✅ Properly resize canvas based on pixel ratio
  function resizeCanvas(canvas) {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext('2d').scale(ratio, ratio);
  }

  // ✅ Clear the signature area
  function clearSignature() {
    if (signaturePad) signaturePad.clear();
  }

  // ✅ Apply signature to preview
  function applySignature() {
    if (!signaturePad || signaturePad.isEmpty()) {
      alert("Please draw a signature before applying.");
      return;
    }

    const dataUrl = signaturePad.toDataURL("image/png");
    document.getElementById("signaturePreview").src = dataUrl;
    currentSignature = dataUrl;

    $('#signatureModal').modal('hide');
  }

  // ✅ Save signature (download)
  function saveSignature() {
    if (!currentSignature) {
      alert("No signature to save.");
      return;
    }

    const link = document.createElement('a');
    link.href = currentSignature;
    link.download = 'signature.png';
    link.click();
  }
</script>

</body>
</html>
